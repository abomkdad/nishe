<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุนุฑูุถ ุงูุนุทูุฑ ุงูููุด ูุงูุณููุชู ุงูุญุตุฑูุฉ</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        :root {
            --primary-color: #5d4037;
            --secondary-color: #8d6e63;
            --background-color: #f4f4f4;
            --cart-color: #fff8e1;
            --whatsapp-color: #25D366;
        }

        body { 
            font-family: Tahoma, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--background-color); 
            color: #333; 
        }
        
        /* ุชุตููู ุงูุฑุฃุณ (Header) */
        header { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 15px 10px; 
            text-align: center;
        }
        
        /* ุฅุนุฏุงุฏ ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ */
        main { 
            display: flex; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 10px; 
            flex-wrap: wrap; 
        }
        
        /* ุฅุนุฏุงุฏ ูุณู ุงูุนุฑุถ ุงูุฑุฆูุณู (ููุนุทูุฑ) */
        section { 
            flex: 3; 
            padding: 10px; 
            background: white; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        
        /* ุชุตููู ุงููุงุฑูุณูู (ุนุฑุถ ุฃููู ููุงุจู ููุชูุฑูุฑ) */
        .perfume-carousel { 
            display: flex;
            overflow-x: auto; 
            scroll-snap-type: x mandatory; 
            padding: 10px 0;
            gap: 12px;
            margin-top: 15px;
            -webkit-overflow-scrolling: touch;
            /* ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฑูุฑ ุงูุฃููู ุนูู ุงููุชุตูุญุงุช */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        .perfume-carousel::-webkit-scrollbar { /* Chrome, Safari, Opera */
            display: none;
        }
        
        .perfume-item { 
            flex: 0 0 auto; 
            width: 150px; /* ุนุฑุถ ููุงุณุจ ููุฌูุงู */
            border: 1px solid #ddd; padding: 8px; text-align: center; background: #fff; border-radius: 6px; 
            scroll-snap-align: start; 
            transition: transform 0.2s; 
        }
        .perfume-item img { width: 100%; height: auto; max-height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; }
        
        /* ุฒุฑ ุงูุฅุถุงูุฉ ููุณูุฉ */
        .add-to-cart { 
            background-color: var(--secondary-color); 
            color: white; 
            border: none; padding: 7px 10px; cursor: pointer; border-radius: 4px; 
            margin-top: 5px; font-weight: bold; width: 100%; 
        }

        /* ุชูุณูู ููุฎุต ุงูุณูุฉ ููุฌูุงู ูุงูุฏูุณูุชูุจ */
        #cart-summary { 
            flex: 1; 
            padding: 15px; 
            background: var(--cart-color); 
            border: 1px solid #ffecb3; 
            border-radius: 8px; 
            position: sticky; 
            top: 10px; 
            height: fit-content; 
            min-width: 250px; 
            margin-right: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #cart-list { list-style: none; padding: 0; }
        #total-price { font-weight: bold; color: #b71c1c; font-size: 1.5em; }
        .gift { color: green; font-weight: bold; }
        .discount { color: orange; font-weight: bold; }
        
        #whatsapp-send-button { 
            background-color: var(--whatsapp-color); 
            color: white; border: none; padding: 12px; width: 100%; 
            margin-top: 15px; border-radius: 6px; cursor: pointer; 
            font-size: 1.1em; font-weight: bold; 
        }

        /* ************************************** */
        /* ุชุนุฏููุงุช ูุฎุตุตุฉ ููุฌูุงู (Mobile-Specific) */
        /* ************************************** */
        @media (max-width: 768px) {
            main { 
                flex-direction: column; 
                padding-bottom: 120px; /* ูุฅุนุทุงุก ูุณุงุญุฉ ููุณูุฉ ุงูุซุงุจุชุฉ */
            }
            
            section { 
                padding: 10px; 
                margin-bottom: 10px;
            }
            
            /* ุชุซุจูุช ุงูุณูุฉ ูู ุฃุณูู ุงูุดุงุดุฉ */
            #cart-summary {
                position: fixed; /* ุชุซุจูุช ุงููููุน */
                bottom: 0; /* ูู ุงูุฃุณูู */
                left: 0;
                right: 0;
                width: 100%;
                z-index: 1000; /* ูุชุจูู ููู ูู ุดูุก */
                border-radius: 0;
                margin-right: 0;
                padding: 10px 15px;
                box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            }
            
            /* ุฅุฎูุงุก ูุงุฆูุฉ ุงูุนุทูุฑ ูู ุงูุณูุฉ ุนูู ุงูุฌูุงู ุงูุตุบูุฑ ูุชูููุฑ ูุณุงุญุฉ */
            #cart-list {
                max-height: 50px;
                overflow: hidden;
                margin-bottom: 5px;
            }
            #cart-summary h2 {
                display: none; /* ุฅุฎูุงุก ุงูุนููุงู ูุชูููุฑ ูุณุงุญุฉ */
            }

            /* ุชุฑุชูุจ ุนูุงุตุฑ ููุฎุต ุงูุณูุฉ ูู ุณุทุฑ ูุงุญุฏ ูุชููู ูุฏูุฌุฉ */
            #cart-summary > h3, #whatsapp-send-button {
                display: block;
                width: 100%;
                text-align: center;
                margin: 5px 0;
            }
            
            #whatsapp-send-button {
                font-size: 1em;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>โจ ุนุฑูุถ ุงูุนุทูุฑ ุงููุงุฎุฑุฉ ูุง ุชููุงูู! โจ</h1>
        <p>โญ ุงุฎุชุฑ ุนุทูุฑ **ุงูููุด** ูุงุณุชูุฏ ูู ุงูุฎุตููุงุช ุฃู ุงููุฏุงูุง ุนูู ุนุทูุฑ **ุงูุณููุชู**.</p>
    </header>

    <main>
        <section id="perfume-display">
            <h2>ุฌุงุฑู ุชุญููู ุงูุนุทูุฑ...</h2>
        </section>

        <aside id="cart-summary">
            <h2>๐ ููุฎุต ุงูุณูุฉ</h2>
            <ul id="cart-list"></ul>
            <h3>ุงูุฅุฌูุงูู: <span id="total-price">0.00 โช</span></h3>
            
            <button id="whatsapp-send-button" disabled>
                ุฃุฑุณู ูู ุงูุทูุจ ุนุจุฑ ูุงุชุณุงุจ
            </button>
            
            <p style="font-size: 0.85em; margin-top: 15px; color: #666;">* ูุชู ุชุทุจูู ุงูุนุฑุถ ุชููุงุฆููุง ุนูู ุฃุฑุฎุต ุนุทุฑ ุณููุชู ูู ุงูุณูุฉ.</p>
        </aside>
    </main>

    <script>
        // ******************************************************
        // 1. ุฑุงุจุท JSON/GViz ูู ููู Google Sheet ุงูุฎุงุต ุจู
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1g3_D2NBwT27O2OI-v1R5tAB2QCfF3_ZCUL9sSLoCv54/gviz/tq?tqx=out:json';
        
        // 2. ุฑูู ุงููุงุชุณุงุจ ุงูุฎุงุต ุจู
        const PHONE_NUMBER = "972522511749"; 
        
        // 3. ุฑูุฒ ุงูุนููุฉ (ุงูุดููู)
        const CURRENCY_SYMBOL = " โช";

        // 4. ูุทุงูุงุช ุงูุฃุณุทุฑ ููุชุตููู
        const ROWS_RANGES = {
            'selective_men': { start: 2, end: 109 },
            'selective_woman': { start: 110, end: 231 },
            'niche': { start: 232, end: 289 }
        };
        // ******************************************************

        let allPerfumes = [];
        let cart = [];

        // ุฏุงูุฉ ูุฅูุดุงุก ุนูุตุฑ ุนุทุฑ HTML
        function createPerfumeItem(perfume) {
            const div = document.createElement('div');
            div.className = 'perfume-item';
            div.dataset.id = perfume.id;
            div.dataset.type = perfume.type;
            div.dataset.price = perfume.price;
            div.dataset.name = perfume.name;

            let imgUrl = perfume.image && perfume.image.trim() ? perfume.image : 'https://via.placeholder.com/180?text=No+Image';

            // ููุทู ุชุตุญูุญ ุงูุฑุงุจุท ูุถูุงู HTTPS
            if (imgUrl.startsWith('http://') && !imgUrl.startsWith('https://')) {
                imgUrl = imgUrl.replace('http://', 'https://');
            }

            div.innerHTML = `
                <img src="${imgUrl}" alt="${perfume.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/180?text=No+Image';">
                <h3>${perfume.name}</h3>
                <p>ุงูุณุนุฑ: ${perfume.price.toFixed(2)}${CURRENCY_SYMBOL}</p>
                <button class="add-to-cart">ุฃุถู ููุณูุฉ</button>
            `;
            return div;
        }

        // ุฏุงูุฉ ุนุฑุถ ุงูุนุทูุฑ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
        function renderPerfumes() {
            const displaySection = document.getElementById('perfume-display');
            displaySection.innerHTML = ''; 

            const nichePerfumes = allPerfumes.filter(p => p.type === 'niche');
            const selectiveMenPerfumes = allPerfumes.filter(p => p.type === 'selective_men');
            const selectiveWomanPerfumes = allPerfumes.filter(p => p.type === 'selective_woman');
            
            // 1. ุนุฑุถ ุนุทูุฑ ุงูููุด (ุงููุณู ุงูุฃูู)
            displaySection.innerHTML += '<h2>ุนุทูุฑ ุงูููุด ุงููุงุฎุฑุฉ</h2><div class="perfume-carousel" id="niche-carousel"></div>';
            const nicheCarousel = document.getElementById('niche-carousel');
            nichePerfumes.forEach(p => nicheCarousel.appendChild(createPerfumeItem(p)));

            // 2. ุนุฑุถ ุนุทูุฑ ุณููุชู ุฑุฌุงูู (ุงููุณู ุงูุซุงูู)
            displaySection.innerHTML += '<hr style="margin: 30px 0;"><h2>ุนุทูุฑ ุณููุชู ุฑุฌุงูู</h2><div class="perfume-carousel" id="selective-men-carousel"></div>';
            const selectiveMenCarousel = document.getElementById('selective-men-carousel');
            selectiveMenPerfumes.forEach(p => selectiveMenCarousel.appendChild(createPerfumeItem(p)));
            
            // 3. ุนุฑุถ ุนุทูุฑ ุณููุชู ูุณุงุฆู (ุงููุณู ุงูุซุงูุซ)
            displaySection.innerHTML += '<hr style="margin: 30px 0;"><h2>ุนุทูุฑ ุณููุชู ูุณุงุฆู</h2><div class="perfume-carousel" id="selective-woman-carousel"></div>';
            const selectiveWomanCarousel = document.getElementById('selective-woman-carousel');
            selectiveWomanPerfumes.forEach(p => selectiveWomanCarousel.appendChild(createPerfumeItem(p)));

            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', addToCart);
            });
        }

        // ุฏุงูุฉ ูุนุงูุฌุฉ ุจูุงูุงุช ุงูุดูุช (ุงูููุฑุณูุฉ ููู)
        function fetchAndProcessProducts() {
            $.get(SHEET_URL, function (response) {
                try {
                    const jsonText = response.match(/google\.visualization\.Query\.setResponse\((.*)\)/)[1];
                    const jsonData = JSON.parse(jsonText);
                    const rows = jsonData.table.rows;

                    const processedProducts = [];

                    // ุชุฌุงูุฒ ุงูุณุทุฑ ุงูุฃูู (ุฑุคูุณ ุงูุฃุนูุฏุฉ) ููุจุฏุฃ ุนุฏ ุงูุฃุณุทุฑ ูู 2 ูู ุงูุดูุช
                    for (let i = 0; i < rows.length; i++) {
                        
                        // ุงูุณุทุฑ ุงููุนูู ูู ุงูุดูุช ูู i + 2
                        const sheetRowNumber = i + 2; 
                        
                        // *** ุฅููุงู ุงูููุชุฌุงุช ุจุนุฏ ุงูุณุทุฑ 289 ***
                        if (sheetRowNumber > 289) break; 
                        
                        const row = rows[i].c;

                        // ูุฑุงุกุฉ ุงูุจูุงูุงุช ุจูุงุกู ุนูู ููุงูุน ุงูุฃุนูุฏุฉ ูู ุงูุดูุช:
                        const productName = row[0]?.v || '';     // C0 (ุงูุนููุฏ A)
                        const productCategoryRaw = row[1]?.v || ''; // C1 (ุงูุนููุฏ B: ุงููุตู)
                        const productPriceC2 = parseFloat(row[2]?.v) || 0; // C2 (ุงูุนููุฏ C)
                        const productImageLink = row[3]?.v || ''; // C3 (ุงูุนููุฏ D)
                        const priceFromF = parseFloat(row[5]?.v) || 0; // C5 (ุงูุนููุฏ F: ุงูุณุนุฑ)
                        
                        const finalPrice = priceFromF > 0 ? priceFromF : productPriceC2;

                        // ุชุฌุงูู ุงูุณุทูุฑ ุงูุชู ูุง ุชุญุชูู ุนูู ุงุณู ุฃู ุณุนุฑ ุตุงูุญ
                        if (!productName || finalPrice === 0) continue; 
                        
                        let type = '';
                        let namePrefix = '';
                        
                        // *** ููุทู ุงูุชุตููู ุจูุงุกู ุนูู ุฑูู ุงูุณุทุฑ ***
                        if (sheetRowNumber >= ROWS_RANGES.niche.start && sheetRowNumber <= ROWS_RANGES.niche.end) {
                            type = 'niche';
                        } else if (sheetRowNumber >= ROWS_RANGES.selective_men.start && sheetRowNumber <= ROWS_RANGES.selective_men.end) {
                            type = 'selective_men';
                            namePrefix = 'ุฑุฌุงูู: ';
                        } else if (sheetRowNumber >= ROWS_RANGES.selective_woman.start && sheetRowNumber <= ROWS_RANGES.selective_woman.end) {
                            type = 'selective_woman';
                            namePrefix = 'ูุณุงุฆู: ';
                        } else {
                            continue; // ุชุฌุงูู ุฃู ุณุทุฑ ุฎุงุฑุฌ ุงููุทุงูุงุช ุงููุญุฏุฏุฉ
                        }

                        processedProducts.push({
                            id: productName.substring(0, 50) + '-' + sheetRowNumber,
                            name: namePrefix + productName,
                            price: finalPrice,
                            image: productImageLink,
                            type: type // niche, selective_men, selective_woman
                        });
                    }

                    allPerfumes = processedProducts;
                    renderPerfumes();
                    document.getElementById('whatsapp-send-button').disabled = false;

                } catch (e) {
                    console.error("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุจูุงูุงุช ุงูุดูุช:", e);
                    document.getElementById('perfume-display').innerHTML = '<h2>ุนุฐุฑุงูุ ูู ูุชููู ูู ุชุญููู ุจูุงูุงุช ุงูุนุทูุฑ. ุชุญูู ูู ุฑุงุจุท ุงูุดูุช ูุตูุงุญูุฉ ุงูุฃุนูุฏุฉ.</h2>';
                }
            });
        }
        
        // ุฏุงูุฉ ุฅุถุงูุฉ ุนุทุฑ ููุณูุฉ (ูุญุฏุซุฉ)
        function addToCart(event) {
            const itemElement = event.target.closest('.perfume-item');
            if (!itemElement) return;

            const itemId = itemElement.dataset.id;
            
            if (cart.some(item => item.id === itemId)) {
                 alert("ูุฐุง ุงูุนุทุฑ ูุถุงู ุจุงููุนู ุฅูู ุงูุณูุฉ.");
                 return;
            }

            const item = {
                id: itemId,
                name: itemElement.dataset.name,
                type: itemElement.dataset.type,
                basePrice: parseFloat(itemElement.dataset.price),
                finalPrice: parseFloat(itemElement.dataset.price),
                isDiscounted: false,
                isFreeGift: false
            };
            
            cart.push(item);
            updateCartAndOffers();
        }

        // ุฏุงูุฉ ุชุญุฏูุซ ุงูุนุฑูุถ (ุงูููุทู ุงููุฏูุฌ)
        function updateCartAndOffers() {
            // 1. ุฅุนุงุฏุฉ ุชุนููู ุฃุณุนุงุฑ ุงูุณููุชู
            cart.forEach(item => {
                if (item.type.startsWith('selective')) {
                    item.finalPrice = item.basePrice; 
                    item.isDiscounted = false;
                    item.isFreeGift = false;
                }
            });

            // 2. ุญุณุงุจ ุนุฏุฏ ุนุทูุฑ ุงูููุด
            const nicheCount = cart.filter(item => item.type === 'niche').length;

            // 3. ุชุญุฏูุฏ ุฃุฑุฎุต ุนุทุฑ ุณููุชู ูู ุงูุณูุฉ ูุชุทุจูู ุงูุนุฑุถ ุนููู
            let selectiveItems = cart
                .filter(item => item.type.startsWith('selective')) // ูุดูู ุงูุฑุฌู ูุงููุณุงุก
                .sort((a, b) => a.basePrice - b.basePrice); 
            
            // ุชุทุจูู ุงูุนุฑุถ ุนูู ุฃุฑุฎุต ุนุทุฑ ุณููุชู ูุงุญุฏ ููุท
            if (selectiveItems.length > 0) {
                const cheapestSelective = selectiveItems[0]; 

                if (nicheCount === 1) {
                    // ุงูุนุฑุถ ุงูุฃูู: 1 ููุด = ุณููุชู ุจูุตู ุงูุณุนุฑ (50%)
                    cheapestSelective.finalPrice = cheapestSelective.basePrice / 2;
                    cheapestSelective.isDiscounted = true;

                } else if (nicheCount >= 2) {
                    // ุงูุนุฑุถ ุงูุซุงูู: 2 ููุด ุฃู ุฃูุซุฑ = ุณููุชู ูุฏูุฉ ูุฌุงููุฉ (0โช)
                    cheapestSelective.finalPrice = 0;
                    cheapestSelective.isDiscounted = true;
                    cheapestSelective.isFreeGift = true;
                }
            }
            renderCartSummary();
        }

        // ุฏุงูุฉ ูุนุฑุถ ููุฎุต ุงูุณูุฉ
        function renderCartSummary() {
            const cartList = document.getElementById('cart-list');
            const totalPriceElement = document.getElementById('total-price');
            let total = 0;
            cartList.innerHTML = ''; 

            cart.forEach(item => {
                total += item.finalPrice;
                const li = document.createElement('li');
                
                let priceText = `${item.finalPrice.toFixed(2)}${CURRENCY_SYMBOL}`;

                if (item.isDiscounted) {
                    if (item.isFreeGift) {
                        priceText = `<span class="gift">ูุฏูุฉ ูุฌุงููุฉ!</span> <del>${item.basePrice.toFixed(2)}${CURRENCY_SYMBOL}</del>`;
                    } else {
                        priceText = `<span class="discount">${priceText}</span> <del>${item.basePrice.toFixed(2)}${CURRENCY_SYMBOL}</del> (ุฎุตู 50%)`;
                    }
                } else {
                    priceText = `${item.basePrice.toFixed(2)}${CURRENCY_SYMBOL}`;
                }

                li.innerHTML = `<strong>${item.name}</strong> (${item.type.includes('niche') ? 'ููุด' : 'ุณููุชู'}): ${priceText}`;
                cartList.appendChild(li);
            });

            totalPriceElement.textContent = total.toFixed(2) + CURRENCY_SYMBOL;
        }

        // ุฏุงูุฉ ุฅุฑุณุงู ุงูุทูุจ ุนุจุฑ ูุงุชุณุงุจ
        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                alert("ุณูุฉ ุงููุดุชุฑูุงุช ูุงุฑุบุฉ.");
                return;
            }

            const nicheCount = cart.filter(item => item.type === 'niche').length;
            let message = "๐ *ุทูุจ ุนุทูุฑ ุฌุฏูุฏ:*\n\n*1. ุงูุนุทูุฑ ุงููุฎุชุงุฑุฉ:*\n";
            let total = 0;

            cart.forEach(item => {
                total += item.finalPrice;
                let priceText = `${item.finalPrice.toFixed(2)}${CURRENCY_SYMBOL}`;

                if (item.isDiscounted) {
                    priceText = (item.finalPrice === 0) 
                                ? "๐ *ูุฏูุฉ ูุฌุงููุฉ*"
                                : "๐ฐ *" + item.finalPrice.toFixed(2) + CURRENCY_SYMBOL + "* (ุฎุตู 50%)";
                } else {
                    priceText = item.basePrice.toFixed(2) + CURRENCY_SYMBOL;
                }

                message += `\n- ${item.name} (${item.type.includes('niche') ? 'ููุด' : 'ุณููุชู'}): ${priceText}`;
            });

            let offerSummary = "\n\n*2. ููุฎุต ุงูุนุฑุถ:*";
            if (nicheCount === 1) {
                offerSummary += "\n- ุชู ุชุทุจูู ุนุฑุถ *ุนุทุฑ ุณููุชู ุจูุตู ุงูุณุนุฑ*.";
            } else if (nicheCount >= 2) {
                offerSummary += "\n- ุชู ุชุทุจูู ุนุฑุถ *ุนุทุฑ ุณููุชู ูุฏูุฉ ูุฌุงููุฉ*.";
            } else {
                offerSummary += "\n- ูู ูุชู ุชุทุจูู ุนุฑุถ.";
            }
            message += offerSummary;
            
            message += `\n\n====================\n`;
            message += `๐ต *ุงูุฅุฌูุงูู ุงูููุงุฆู:* ${total.toFixed(2)}${CURRENCY_SYMBOL}`;
            
            const pageUrl = window.location.href; 
            message += `\n\nูุฅุชูุงู ุงูุทูุจ ูุฑุคูุฉ ุงูุตูุฑุ ูุฑุฌู ุงูุฑุฏ ุนูู ูุฐู ุงูุฑุณุงูุฉ.\n(ุฑุงุจุท ุงูุทูุจ: ${pageUrl})`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${PHONE_NUMBER}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // ุชุดุบูู ุฌูุจ ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndProcessProducts();
            document.getElementById('whatsapp-send-button').addEventListener('click', sendOrderViaWhatsApp);
        });
    </script>
</body>
</html>
