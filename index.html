<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">عروض العطور النيش والسلكتف الحصرية</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    :root {
      --primary-color: #5d4037;
      --secondary-color: #8d6e63;
      --background-color: #f4f4f4;
      --cart-color: #fff8e1;
      --whatsapp-color: #25D366;
      --delete-color: #d32f2f;
      --hint-green: #1b5e20;
    }

    body { font-family: Tahoma, sans-serif; margin: 0; padding: 0 0 120px 0; background-color: var(--background-color); color: #333; min-height: 100vh; }
    header { background-color: var(--primary-color); color: #fff; padding: 20px 10px; text-align: center; }
    main { max-width: 1200px; margin: 0 auto; padding: 10px; }
    section { background: #fff; border-radius: 10px; margin-bottom: 20px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }

    /* تبويبات الفئات */
    .category-tabs { display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 8px; }
    .category-tabs button { flex:1 1 auto; padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius:10px; font-size:1rem; cursor:pointer; }
    .category-tabs button.active { background: var(--primary-color); color:#fff; border-color: var(--primary-color); }

    /* قائمة المنتجات */
    .products-list { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 680px){ .products-list { grid-template-columns: 1fr; } }
    .product-card { border:1px solid #e5e5e5; border-radius:12px; padding:10px; background:#fff; display:flex; gap:10px; align-items:center; }
    .product-card img { width:90px; height:90px; object-fit:cover; border-radius:10px; flex:0 0 auto; border:1px solid #eee; }
    .product-info { flex:1 1 auto; display:flex; flex-direction:column; gap:6px; }
    .product-name { font-size:1rem; line-height:1.3; }
    .product-price { font-weight:700; color:#1b5e20; font-size:1.05rem; }
    .product-card .add-to-cart { width:auto; padding:10px 12px; font-size:1rem; border-radius:10px; background:var(--secondary-color); color:#fff; border:none; cursor:pointer; }

    /* شريط التعليمات المبسط */
    .howto {background:#fff3cd;border:1px solid #ffeeba;color:#7c5b00;padding:10px 12px;border-radius:10px;margin:6px 0 12px;}
    .howto strong{display:block;margin-bottom:6px;}

    /* العربة */
    #cart-container { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; z-index: 1000; background-color: #fff; box-shadow: 0 -4px 12px rgba(0,0,0,0.12); }
    #cart-summary { background: var(--cart-color); padding: 12px 15px; display:flex; align-items:center; justify-content: space-between; gap: 10px; }
    #cart-details { flex: 1 1 auto; display: flex; flex-direction: column; }
    #cart-list { list-style: none; padding: 0; margin: 5px 0; max-height: 170px; overflow-y: auto; font-size: 0.95em; }
    #cart-list li { display: grid; grid-template-columns: 48px 1fr auto; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px dashed #eee; }
    .cart-thumb{width:48px;height:48px;border-radius:6px;object-fit:cover;border:1px solid #e5e5e5;background:#fff}
    .item-title{display:flex;align-items:center;gap:8px}
    .delete-item { cursor: pointer; color: var(--delete-color); font-size: 1.15em; opacity: 0.85; transition: opacity 0.2s; }
    .delete-item:hover { opacity: 1; }
    #total-price-display { font-weight: bold; color: #b71c1c; font-size: 1.3em; white-space: nowrap; }
    #whatsapp-send-button { background-color: var(--whatsapp-color); color: #fff; border: none; padding: 12px 18px; border-radius: 10px; cursor: pointer; font-size: 1.05em; font-weight: bold; white-space: nowrap; }
    #shipping-info { font-size: 0.9em; color: #555; }

    /* تلميح العرض داخل العربة */
    #cart-offer-hint { margin: 6px 0 0; font-weight: 800; color: var(--hint-green); text-align: start; }

    /* زر واتساب العائم */
    #floating-whatsapp { position: fixed; bottom: 150px; left: 15px; background-color: var(--whatsapp-color); color: #fff; padding: 12px; border-radius: 50%; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1001; display: flex; align-items: center; justify-content:center; width:56px; height:56px; }
    #floating-whatsapp i { font-size: 1.6em; }

    .error-message { background: #ffebee; color:#b71c1c; border:1px solid #f44336; padding:12px; border-radius:10px; text-align:center; font-weight:bold; }
    .reload-btn { display:inline-block; margin-top:10px; background:#b71c1c; color:#fff; padding:8px 14px; border-radius:8px; text-decoration:none; font-weight:bold; }
  </style>
</head>
<body lang="ar">
  <header>
    <h1 id="header-title">✨ عروض العطور ✨</h1>
    <p id="header-subtitle">اختر عطورك بسهولة وأرسل طلبك عبر واتساب</p>
  </header>

  <main>
    <section id="perfume-display">
      <h2 id="loading-message">جاري تحميل المنتجات...</h2>
    </section>
  </main>

  <a id="floating-whatsapp" href="#" target="_blank" title="WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>

  <div id="cart-container">
    <aside id="cart-summary">
      <div id="cart-details">
        <ul id="cart-list"></ul>
        <p id="cart-offer-hint"></p>
        <p id="shipping-info"></p>
        <div class="cta-wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <span id="total-text"></span>
          <span id="total-price-display">0.00 ₪</span>
        </div>
      </div>
      <button id="whatsapp-send-button" disabled>أكمل الطلب عبر واتساب</button>
    </aside>
  </div>

  <script>
    /********************** إعدادات عامة **********************/
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1g3_D2NBwT27O2OI-v1R5tAB2QCfF3_ZCUL9sSLoCv54/gviz/tq?tqx=out:json';
    const PHONE_NUMBER = '972522511749';
    const CURRENCY_SYMBOL = ' ₪';
    const SHIPPING_FEE = 50;

    // تصنيف صارم حسب أرقام الصفوف
    const STRICT_RANGES = {
      men:   { start: 2,   end: 109 },
      woman: { start: 110, end: 231 },
      niche: { start: 232, end: 289 }
    };

    const DICT = {
      ar: {
        title: '✨ عروض العطور ✨',
        subtitle: 'اختر عطورك بسهولة وأرسل طلبك عبر واتساب',
        loading: 'جارٍ تحميل العطور...',
        niche_header: 'عطور النيش الفاخرة',
        men_header: 'عطور سلكتف رجالي',
        woman_header: 'عطور سلكتف نسائي',
        add_to_cart: 'أضف للسلة',
        whatsapp_float: 'أرغب بعرض النيش',
        error_loading: 'عذراً، لم نتمكن من تحميل بيانات العطور. يرجى التأكد من أن رابط الشيت منشور بشكل صحيح.',
        no_items: 'لا توجد منتجات في هذه الفئة الآن.',
        cart_empty: 'سلة المشتريات فارغة.',
        shipping_text: 'رسوم التوصيل: ' + SHIPPING_FEE.toFixed(2) + CURRENCY_SYMBOL,
        total_text: 'الإجمالي:',
        offer_one_niche: 'الآن اختر عطر سلكتف بنصف السعر',
        offer_two_niche: 'اختر عطر سلكتف هدية مجانية',
        type_men_prefix: 'رجالي: ',
        type_woman_prefix: 'نسائي: ',
        howto_title: 'طريقة الطلب بخطوتين',
        howto_step1: '1) اختر عطرك واضغط أضف للسلة',
        howto_step2: '2) اضغط إتمام الطلب عبر واتساب وارسله لنا',
        msg_gift: 'هدية مجانية',
        msg_discount: 'خصم 50% ',
        msg_order_complete: 'طلب عطور جديد:',
        msg_no_offer: 'لا يوجد عرض.'
      },
      he: {
        title: '✨ מבצעי בישום ✨',
        subtitle: 'בחר ושגר הזמנה בוואטסאפ',
        loading: 'טוען בשמים...',
        niche_header: 'בשמי ניש יוקרתיים',
        men_header: 'בשמי סלקטיב לגבר',
        woman_header: 'בשמי סלקטיב לאישה',
        add_to_cart: 'הוסף לסל',
        whatsapp_float: 'אני רוצה את מבצע הניש',
        error_loading: 'לא הצלחנו לטעון נתונים. ודא שהגיליון פומבי והקישור תקין.',
        no_items: 'אין מוצרים בקטגוריה זו כרגע.',
        cart_empty: 'הסל ריק.',
        shipping_text: 'דמי משלוח: ' + SHIPPING_FEE.toFixed(2) + CURRENCY_SYMBOL,
        total_text: 'סה"כ:',
        offer_one_niche: 'בחר עכשיו בושם סלקטיב בחצי מחיר',
        offer_two_niche: 'בחר בושם סלקטיב מתנה',
        type_men_prefix: 'גבר: ',
        type_woman_prefix: 'אישה: ',
        howto_title: 'איך מזמינים בשתי פעולות',
        howto_step1: '1) בחר בושם ולחץ הוסף לסל',
        howto_step2: '2) לחץ סיים הזמנה בוואטסאפ ושלח',
        msg_gift: 'מתנה חינם',
        msg_discount: '50% הנחה',
        msg_order_complete: 'הזמנת בשמים חדשה:',
        msg_no_offer: 'לא הוחל מבצע.'
      }
    };

    let currentLang = 'ar';
    let allPerfumes = [];
    let cart = [];

    /********************** لغة ونصوص **********************/
    function setLanguage(){
      const browserLang = (navigator.language||'ar').slice(0,2).toLowerCase();
      if (browserLang==='he' || document.documentElement.lang==='he'){
        currentLang = 'he'; document.documentElement.lang='he'; document.documentElement.dir='rtl';
      } else { currentLang='ar'; document.documentElement.lang='ar'; document.documentElement.dir='rtl'; }
      const t = DICT[currentLang];
      document.getElementById('page-title').textContent = t.title;
      document.getElementById('header-title').textContent = t.title;
      document.getElementById('header-subtitle').textContent = t.subtitle;
      document.getElementById('loading-message').textContent = t.loading;
      document.getElementById('total-text').textContent = t.total_text;
      document.getElementById('whatsapp-send-button').textContent = currentLang==='he' ? 'סיים הזמנה בוואטסאפ' : 'إتمام الطلب عبر واتساب';
      const floatA = document.getElementById('floating-whatsapp');
      floatA.href = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(t.whatsapp_float)}`;
      floatA.title = t.whatsapp_float;
    }

    /********************** مساعدات **********************/
    function safeUrl(u){ if(!u) return ''; if(u.startsWith('http://') && !u.startsWith('https://')) return u.replace('http://','https://'); return u; }
    function num(v){ if (typeof v==='number') return v; if (typeof v==='string'){ const n=parseFloat(v.replace(/[^\d.]/g,'')); return isNaN(n)?0:n; } return 0; }
    function parseGoogleVizResponse(response){
      const s = String(response||'').trim();
      if(!s) throw new Error('Empty response from sheet');
      if(s[0]==='<') throw new Error('HTML response instead of JSON (sheet not published?)');
      const m = s.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)\s*;?\s*$/);
      if(!m) throw new Error('Unexpected GViz format');
      return JSON.parse(m[1]);
    }

    /********************** جلب ومعالجة المنتجات **********************/
    function fetchAndProcessProducts(){
      $.get(SHEET_URL).done(function(response){
        try{
          const json = parseGoogleVizResponse(response);
          const rows = json.table?.rows || [];
          const out = [];
          for(let i=0;i<rows.length;i++){
            const c = rows[i].c || [];
            const sheetRow = i+2;
            if (sheetRow>STRICT_RANGES.niche.end) break; // لا نهتم بما بعد 289
            const name = (c[0]&&c[0].v)? String(c[0].v).trim():'';
            const priceC = num(c[2]?.v);
            const img = safeUrl(c[3]?.v||'');
            const priceF = num(c[5]?.v);
            const price = priceF>0 ? priceF : priceC;
            if(!name || price<=0) continue;

            let type='', prefix='';
            if(sheetRow>=STRICT_RANGES.men.start && sheetRow<=STRICT_RANGES.men.end){ type='selective_men'; prefix=DICT[currentLang].type_men_prefix; }
            else if(sheetRow>=STRICT_RANGES.woman.start && sheetRow<=STRICT_RANGES.woman.end){ type='selective_woman'; prefix=DICT[currentLang].type_woman_prefix; }
            else if(sheetRow>=STRICT_RANGES.niche.start && sheetRow<=STRICT_RANGES.niche.end){ type='niche'; }
            else continue;

            out.push({ id: name.substring(0,50)+'-'+sheetRow, name: prefix+name, price, image: img, type });
          }
          allPerfumes = out;
          if(out.length===0){ showErrorMessage(DICT[currentLang].error_loading); }
          else { renderPerfumes('niche'); }
        }catch(e){ console.error(e); showErrorMessage(DICT[currentLang].error_loading); }
      }).fail(function(err){ console.error('XHR fail',err); showErrorMessage(DICT[currentLang].error_loading); });
    }

    /********************** واجهة المنتجات **********************/
    function createCard(p){
      const t = DICT[currentLang];
      const img = p.image && p.image.trim()? p.image : 'https://via.placeholder.com/180?text=No+Image';
      return `
        <div class="product-card" data-id="${p.id}" data-type="${p.type}" data-price="${p.price}" data-name="${p.name}" data-image="${img}">
          <img src="${img}" alt="${p.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/180?text=No+Image';" />
          <div class="product-info">
            <div class="product-name">${p.name}</div>
            <div class="product-price">${p.price.toFixed(2)}${CURRENCY_SYMBOL}</div>
          </div>
          <button class="add-to-cart">${t.add_to_cart}</button>
        </div>`;
    }

    function renderPerfumes(active){
      const t = DICT[currentLang];
      const niche = allPerfumes.filter(p=>p.type==='niche');
      const men   = allPerfumes.filter(p=>p.type==='selective_men');
      const woman = allPerfumes.filter(p=>p.type==='selective_woman');

      const renderList = (arr)=>{
        if(!arr || arr.length===0) return `<p style="text-align:center;color:#777;margin:20px 0;">${t.no_items}</p>`;
        return `<div class="products-list">${arr.map(createCard).join('')}</div>`;
      };

      const el = document.getElementById('perfume-display');
      el.innerHTML = `
        <div class="howto">
          <strong>📌 ${t.howto_title}</strong>
          <div>${t.howto_step1}</div>
          <div>${t.howto_step2}</div>
        </div>
        <div class="category-tabs">
          <button data-cat="niche" class="${active==='niche'?'active':''}">${t.niche_header}</button>
          <button data-cat="selective_men" class="${active==='selective_men'?'active':''}">${t.men_header}</button>
          <button data-cat="selective_woman" class="${active==='selective_woman'?'active':''}">${t.woman_header}</button>
        </div>
        <div id="products-container"></div>`;

      const container = document.getElementById('products-container');
      container.innerHTML = active==='niche'? renderList(niche) : active==='selective_men'? renderList(men) : renderList(woman);

      el.querySelectorAll('.category-tabs button').forEach(btn=>{
        btn.addEventListener('click', ()=> renderPerfumes(btn.getAttribute('data-cat')));
      });

      el.querySelectorAll('.add-to-cart').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const card = e.target.closest('.product-card');
          const id = card.dataset.id; if (cart.some(i=>i.id===id)) return alert('مضاف بالفعل / כבר בסל');
          const basePrice = parseFloat(card.dataset.price)||0;
          cart.push({
            id,
            name: card.dataset.name,
            type: card.dataset.type,
            basePrice,
            finalPrice: basePrice,
            image: card.dataset.image,
            isFreeGift: false
          });
          updateCartAndOffers();
        });
      });
    }

    /********************** السلة والعروض **********************/
    function removeItemFromCart(index){ cart.splice(index,1); updateCartAndOffers(); }
    window.removeItemFromCart = removeItemFromCart;

    function updateCartAndOffers(){
      // reset
      cart.forEach(it=>{ it.finalPrice = it.basePrice; it.isFreeGift=false; });
      const nicheCount = cart.filter(i=>i.type==='niche').length;
      const selective = cart.filter(i=>i.type && i.type.startsWith('selective')).sort((a,b)=>a.basePrice-b.basePrice);
      if (selective.length>0){
        const cheapest = selective[0];
        if (nicheCount===1){ cheapest.finalPrice = cheapest.basePrice/2; }
        else if (nicheCount>=2){ cheapest.finalPrice = 0; cheapest.isFreeGift = true; }
      }
      renderCartSummary();
    }

    function renderCartSummary(){
      const t = DICT[currentLang];
      const ul = document.getElementById('cart-list');
      ul.innerHTML='';
      let subtotal=0;
      cart.forEach((it,idx)=>{
        subtotal += it.finalPrice;
        const li = document.createElement('li');
        li.innerHTML = `
          <img class="cart-thumb" src="${it.image||'https://via.placeholder.com/64?text=%20'}" alt="">
          <div class="item-title"><i class="fas fa-trash-alt delete-item" onclick="removeItemFromCart(${idx})"></i>${it.name}</div>
          <span>${it.isFreeGift? '🎁' : (it.finalPrice.toFixed(2)+CURRENCY_SYMBOL)}</span>`;
        ul.appendChild(li);
      });

      const shippingInfo = document.getElementById('shipping-info');
      const totalEl = document.getElementById('total-price-display');
      document.getElementById('total-text').textContent = t.total_text;
      let finalTotal=subtotal; if(subtotal>0){ shippingInfo.textContent=t.shipping_text; finalTotal+=SHIPPING_FEE; } else { shippingInfo.textContent=''; }
      totalEl.textContent = finalTotal.toFixed(2)+CURRENCY_SYMBOL;
      document.getElementById('whatsapp-send-button').disabled = cart.length===0;
      updateOfferHint();
    }

    function updateOfferHint(){
      const t = DICT[currentLang];
      const hint = document.getElementById('cart-offer-hint');
      const nicheCount = cart.filter(i=>i.type==='niche').length;
      if (nicheCount===1) hint.textContent = '✅ '+t.offer_one_niche;
      else if (nicheCount>=2) hint.textContent = '🎁 '+t.offer_two_niche;
      else hint.textContent='';
    }

    /********************** واتساب **********************/
    function buildWhatsAppMessage(){
      const t = DICT[currentLang];
      let subtotal=0;
      const lines = cart.map(it=>{
        subtotal += it.finalPrice;
        if(it.isFreeGift) return `- ${it.name}: 🎁`;
        return `- ${it.name}: ${it.finalPrice.toFixed(2)}${CURRENCY_SYMBOL}`;
      }).join('\n');
      const finalTotal = subtotal>0? subtotal+SHIPPING_FEE : 0;
      let msg = `🎉 ${currentLang==='he'?t.msg_order_complete:t.msg_order_complete}\n\n${lines}`;
      msg += `\n\n${t.shipping_text}\n${t.total_text} ${finalTotal.toFixed(2)}${CURRENCY_SYMBOL}`;
      // ضمان عدم وجود أحرف عربية في النسخة العبرية
      if(currentLang==='he' && /[\u0600-\u06FF]/.test(msg)){ msg = msg.replace(/[\u0600-\u06FF]/g,''); }
      return msg;
    }

    function sendOrderViaWhatsApp(){
      const t = DICT[currentLang];
      if(cart.length===0) return alert(t.cart_empty);
      const url = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(buildWhatsAppMessage())}`;
      window.open(url,'_blank');
    }

    /********************** رسائل أخطاء وتهيئة **********************/
    function showErrorMessage(msg){
      document.getElementById('perfume-display').innerHTML = `<div class="error-message">${msg}<br><a href="" class="reload-btn">🔄 ${currentLang==='he'?'רענן עמוד':'تحديث الصفحة'}</a></div>`;
    }

    function selfTests(){
      try{
        // 1) فحص تصنيف الصفوف
        const rows=[2,109,110,231,232,289,1,290];
        const expect=['men','men','woman','woman','niche','niche',null,null];
        const mapRow=(r)=> r>=STRICT_RANGES.men.start&&r<=STRICT_RANGES.men.end?'men': r>=STRICT_RANGES.woman.start&&r<=STRICT_RANGES.woman.end?'woman': r>=STRICT_RANGES.niche.start&&r<=STRICT_RANGES.niche.end?'niche':null;
        rows.forEach((r,i)=>console.assert(mapRow(r)===expect[i],`Row ${r} expected ${expect[i]}`));
        // 2) GViz parser
        const fake='google.visualization.Query.setResponse({"table":{"rows":[]}})';
        const parsed=parseGoogleVizResponse(fake); console.assert(parsed.table,'GViz parse ok');
        // 3) عبرية بدون أحرف عربية
        const hebMsg = (function(){ const bak=currentLang; currentLang='he'; const m=buildWhatsAppMessage(); currentLang=bak; return m; })();
        console.assert(!(/[\u0600-\u06FF]/.test(hebMsg)),'Hebrew WA contains Arabic chars');
        console.log('SelfTests OK');
      }catch(e){ console.warn('SelfTests issue',e); }
    }

    /********************** تشغيل **********************/
    document.addEventListener('DOMContentLoaded', ()=>{
      setLanguage();
      fetchAndProcessProducts();
      document.getElementById('whatsapp-send-button').addEventListener('click', sendOrderViaWhatsApp);
      selfTests();
    });
  </script>
</body>
</html>
