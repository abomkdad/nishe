<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عروض العطور النيش والسلكتف الحصرية</title>
    
    <style>
        body { font-family: Tahoma, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
        header { background-color: #5d4037; color: white; padding: 20px; text-align: center; }
        h1 { margin: 0; }
        main { display: flex; max-width: 1200px; margin: 20px auto; padding: 0 15px; flex-wrap: wrap; }
        section { flex: 3; padding: 20px; background: white; border-radius: 8px; margin-bottom: 20px; }
        #cart-summary { flex: 1; padding: 20px; background: #fff8e1; border: 1px solid #ffecb3; border-radius: 8px; position: sticky; top: 20px; height: fit-content; min-width: 250px; margin-right: 20px; }
        .perfume-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
        .perfume-item { border: 1px solid #ddd; padding: 10px; text-align: center; background: #fff; border-radius: 6px; transition: transform 0.2s; }
        .perfume-item:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .perfume-item img { width: 100%; height: auto; max-height: 180px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }
        .add-to-cart { background-color: #8d6e63; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; margin-top: 10px; font-weight: bold; width: 100%; }
        #cart-list { list-style: none; padding: 0; }
        #total-price { font-weight: bold; color: #b71c1c; font-size: 1.5em; }
        .gift { color: green; font-weight: bold; }
        .discount { color: orange; font-weight: bold; }
        #whatsapp-send-button { background-color: #25D366; color: white; border: none; padding: 12px; width: 100%; margin-top: 15px; border-radius: 6px; cursor: pointer; font-size: 1.1em; font-weight: bold; }
        @media (max-width: 900px) {
            main { flex-direction: column; }
            #cart-summary { margin-right: 0; order: -1; }
        }
    </style>
</head>
<body>
    <header>
        <h1>✨ عروض العطور الفاخرة لا تُقاوم! ✨</h1>
        <p>⭐ اختر عطور **النيش** واستفد من الخصومات أو الهدايا على عطور **السلكتف**.</p>
    </header>

    <main>
        <section id="perfume-display">
            <h2>جارٍ تحميل العطور...</h2>
        </section>

        <aside id="cart-summary">
            <h2>🛒 ملخص السلة</h2>
            <ul id="cart-list"></ul>
            <h3>الإجمالي: <span id="total-price">0.00$</span></h3>
            
            <button id="whatsapp-send-button" disabled>
                أرسل لي الطلب عبر واتساب
            </button>
            
            <p style="font-size: 0.85em; margin-top: 15px; color: #666;">* يتم تطبيق العرض تلقائيًا على أرخص عطر سلكتف في السلة.</p>
        </aside>
    </main>

    <script>
        // ******************************************************
        // 1. رابط CSV من ملف Google Sheet الخاص بك
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWJMujOko7GbRtvG94b1bNA3TEeSNh7aL4AJFOazRcdlbGEThnkevfzuJXdSpo0ym8xK3KveAK_m0_/pub?output=csv"; 
        
        // 2. رقم الواتساب الخاص بك
        const PHONE_NUMBER = "972522511749"; 
        // ******************************************************

        let allPerfumes = [];
        let cart = [];

        // دالة لتحويل بيانات CSV إلى مصفوفة JavaScript
        function csvToArray(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim()); 
            const result = [];
            // الحلقة تبدأ من i = 1 لتجاهل السطر الأول (رؤوس الأعمدة)
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const currentline = lines[i].match(/(".*?"|[^",\s]+)(?=\s*\,|\s*$)/g);
                if (!currentline) continue;
                
                const obj = {};
                let name = ''; 
                let description = '';
                let price = 0;
                let imageLink = '';
                
                for (let j = 0; j < headers.length; j++) {
                    let value = (currentline[j] || "").replace(/"/g, "").trim();
                    
                    // قراءة الأعمدة بناءً على التسميات الجديدة
                    if (headers[j] === 'a perfume name') { 
                        name = value;
                    } else if (headers[j] === 'e Description') { // تصنيف العطر
                        description = value;
                    } else if (headers[j] === 'f price') { // السعر
                        price = parseFloat(value);
                    } else if (headers[j] === 'd imege link') { // رابط الصورة
                        imageLink = value;
                    } 
                }
                
                // تعيين القيم النهائية
                obj.ImageURL = imageLink;
                obj.Price = price;
                obj.Name = name;
                obj.ID = name.substring(0, 50); // استخدام جزء من الاسم كمعرف ID

                // *** منطق التصنيف الرئيسي بناءً على عمود e Description ***
                const descLower = description.toLowerCase();

                if (descLower.includes('niche')) {
                    obj.Type = 'niche';
                } else if (descLower.includes('man')) {
                    obj.Type = 'selective'; 
                    obj.Name = 'رجالي: ' + name;
                } else if (descLower.includes('woman') || descLower.includes('women')) {
                    obj.Type = 'selective'; 
                    obj.Name = 'نسائي: ' + name;
                } else {
                    obj.Type = 'selective'; // افتراضياً سلكتف
                }

                // التأكد من أن العناصر الأساسية موجودة وصالحة قبل الإضافة
                if (obj.ID && obj.Name && !isNaN(obj.Price) && obj.Price > 0) {
                    result.push(obj);
                }
            }
            return result;
        }

        // دالة لجلب البيانات من Google Sheet
        async function fetchPerfumes() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("فشل في جلب البيانات من ملف الشيت.");
                const csvText = await response.text();
                allPerfumes = csvToArray(csvText);
                
                // تحضير البيانات لضمان أن التصنيف niche أو selective
                allPerfumes = allPerfumes.map(p => ({
                    ID: p.ID,
                    Name: p.Name,
                    Type: p.Type.toLowerCase().includes('niche') ? 'niche' : 'selective', 
                    Price: p.Price,
                    ImageURL: p.ImageURL
                })).filter(p => !isNaN(p.Price) && p.Price > 0); 

                renderPerfumes();
                document.getElementById('perfume-display').querySelector('h2').textContent = 'العطور المتوفرة';
                document.getElementById('whatsapp-send-button').disabled = false;
            } catch (error) {
                console.error("خطأ في تحميل العطور:", error);
                document.getElementById('perfume-display').innerHTML = '<h2>عذراً، حدث خطأ في تحميل بيانات العطور. يرجى التحقق من رابط الشيت أو إعدادات النشر.</h2>';
            }
        }

        // دالة عرض العطور في واجهة المستخدم
        function renderPerfumes() {
            const displaySection = document.getElementById('perfume-display');
            displaySection.innerHTML = ''; 

            const nichePerfumes = allPerfumes.filter(p => p.Type === 'niche');
            const selectivePerfumes = allPerfumes.filter(p => p.Type === 'selective');

            // 1. عرض عطور النيش
            displaySection.innerHTML += '<h2>عطور النيش الفاخرة</h2><div class="perfume-grid" id="niche-grid"></div>';
            const nicheGrid = document.getElementById('niche-grid');
            if (nichePerfumes.length === 0) { nicheGrid.innerHTML = '<p>لا توجد عطور نيش متوفرة حالياً.</p>'; }
            nichePerfumes.forEach(p => nicheGrid.appendChild(createPerfumeItem(p)));

            // 2. عرض عطور السلكتف
            displaySection.innerHTML += '<hr style="margin: 30px 0;"><h2>عطور السلكتف (نسائية ورجالية)</h2><p>يمكن تطبيق العرض على أي عطر من هذه المجموعة.</p><div class="perfume-grid" id="selective-grid"></div>';
            const selectiveGrid = document.getElementById('selective-grid');
            if (selectivePerfumes.length === 0) { selectiveGrid.innerHTML = '<p>لا توجد عطور سلكتف متوفرة حالياً.</p>'; }
            selectivePerfumes.forEach(p => selectiveGrid.appendChild(createPerfumeItem(p)));

            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', addToCart);
            });
        }

        // دالة لإنشاء عنصر عطر HTML
        function createPerfumeItem(perfume) {
            const div = document.createElement('div');
            div.className = 'perfume-item';
            div.dataset.id = perfume.ID;
            div.dataset.type = perfume.Type;
            div.dataset.price = perfume.Price;
            div.dataset.name = perfume.Name;

            const imgUrl = perfume.ImageURL && perfume.ImageURL.trim() ? perfume.ImageURL : 'https://via.placeholder.com/180?text=No+Image';

            div.innerHTML = `
                <img src="${imgUrl}" alt="${perfume.Name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/180?text=No+Image';">
                <h3>${perfume.Name}</h3>
                <p>السعر: ${perfume.Price.toFixed(2)}$</p>
                <button class="add-to-cart">أضف للسلة</button>
            `;
            return div;
        }

        // دالة إضافة عطر للسلة (محدثة)
        function addToCart(event) {
            const itemElement = event.target.closest('.perfume-item');
            if (!itemElement) return;

            const itemId = itemElement.dataset.id;
            if (cart.some(item => item.id === itemId)) {
                alert("هذا العطر مضاف بالفعل إلى السلة.");
                return;
            }

            const item = {
                id: itemId,
                name: itemElement.dataset.name,
                type: itemElement.dataset.type,
                basePrice: parseFloat(itemElement.dataset.price),
                finalPrice: parseFloat(itemElement.dataset.price),
                isDiscounted: false 
            };
            
            cart.push(item);
            updateCartAndOffers();
        }

        // دالة تحديث العروض (محدثة)
        function updateCartAndOffers() {
            cart.forEach(item => {
                if (item.type === 'selective') {
                    item.finalPrice = item.basePrice; 
                    item.isDiscounted = false;
                }
            });

            const nicheCount = cart.filter(item => item.type === 'niche').length;

            let selectiveItems = cart
                .filter(item => item.type === 'selective')
                .sort((a, b) => a.basePrice - b.basePrice); 

            if (selectiveItems.length > 0) {
                const cheapestSelective = selectiveItems[0]; 

                if (nicheCount === 1) {
                    cheapestSelective.finalPrice = cheapestSelective.basePrice / 2;
                    cheapestSelective.isDiscounted = true;

                } else if (nicheCount >= 2) {
                    cheapestSelective.finalPrice = 0;
                    cheapestSelective.isDiscounted = true;
                }
            }
            renderCartSummary();
        }

        // دالة لعرض ملخص السلة
        function renderCartSummary() {
            const cartList = document.getElementById('cart-list');
            const totalPriceElement = document.getElementById('total-price');
            let total = 0;
            cartList.innerHTML = ''; 

            cart.forEach(item => {
                total += item.finalPrice;
                const li = document.createElement('li');
                
                let priceText = `${item.finalPrice.toFixed(2)}$`;

                if (item.isDiscounted) {
                    if (item.finalPrice === 0) {
                        priceText = `<span class="gift">هدية مجانية!</span> <del>${item.basePrice.toFixed(2)}$</del>`;
                    } else {
                        priceText = `<span class="discount">${priceText}</span> <del>${item.basePrice.toFixed(2)}$</del> (خصم 50%)`;
                    }
                } else {
                    priceText = `${item.basePrice.toFixed(2)}$`;
                }

                li.innerHTML = `<strong>${item.name}</strong> (${item.type === 'niche' ? 'نيش' : 'سلكتف'}): ${priceText}`;
                cartList.appendChild(li);
            });

            totalPriceElement.textContent = total.toFixed(2) + '$';
        }

        // دالة إرسال الطلب عبر واتساب
        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                alert("سلة المشتريات فارغة.");
                return;
            }

            const nicheCount = cart.filter(item => item.type === 'niche').length;
            let message = "🎉 *طلب عطور جديد:*\n\n*1. العطور المختارة:*\n";
            let total = 0;

            cart.forEach(item => {
                total += item.finalPrice;
                let priceText = `${item.finalPrice.toFixed(2)}$`;

                if (item.isDiscounted) {
                    priceText = (item.finalPrice === 0) 
                                ? "🎁 *هدية مجانية*"
                                : "💰 *" + item.finalPrice.toFixed(2) + "$* (خصم 50%)";
                } else {
                    priceText = item.basePrice.toFixed(2) + "$";
                }

                message += `\n- ${item.name} (${item.type === 'niche' ? 'نيش' : 'سلكتف'}): ${priceText}`;
            });

            let offerSummary = "\n\n*2. ملخص العرض:*";
            if (nicheCount === 1) {
                offerSummary += "\n- تم تطبيق عرض *عطر سلكتف بنصف السعر*.";
            } else if (nicheCount >= 2) {
                offerSummary += "\n- تم تطبيق عرض *عطر سلكتف هدية مجانية*.";
            } else {
                offerSummary += "\n- لم يتم تطبيق عرض.";
            }
            message += offerSummary;
            
            message += `\n\n====================\n`;
            message += `💵 *الإجمالي النهائي:* ${total.toFixed(2)}$`;
            
            const pageUrl = window.location.href; 
            message += `\n\nلإتمام الطلب ورؤية الصور، يرجى الرد على هذه الرسالة.\n(رابط الطلب: ${pageUrl})`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${PHONE_NUMBER}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // تشغيل جلب البيانات عند تحميل الصفحة وربط زر الواتساب
        document.addEventListener('DOMContentLoaded', () => {
            fetchPerfumes();
            document.getElementById('whatsapp-send-button').addEventListener('click', sendOrderViaWhatsApp);
        });
    </script>
</body>
</html>
