function fetchAndProcessProducts() {
  $.get(SHEET_URL, function (response) {
    try {
      const match = response.match(/google\.visualization\.Query\.setResponse\((.*)\)/);
      if (!match || !match[1]) throw new Error('Bad sheet response');

      const jsonData = JSON.parse(match[1]);
      const rows = jsonData.table?.rows || [];
      const processed = [];

      for (let i = 0; i < rows.length; i++) {
        const c = rows[i].c || [];

        // أعمدة مرنة + تنظيف
        const nameRaw   = c[0]?.v ?? '';
        const priceC2   = parseFloat(String(c[2]?.v ?? '').replace(/[^\d.]/g, '')) || 0; // C2
        const imageRaw  = String(c[3]?.v ?? '').trim();                                   // C3
        const priceF    = parseFloat(String(c[5]?.v ?? '').replace(/[^\d.]/g, '')) || 0; // C5 (F)
        const typeRaw   = String(c[4]?.v ?? '').trim().toLowerCase();                    // C4 (اختياري)

        const productName  = String(nameRaw).trim();
        const finalPrice   = priceF > 0 ? priceF : priceC2;
        if (!productName || finalPrice <= 0) continue;

        // اكتشاف النوع تلقائيًا
        let type = 'niche';
        const mapTypeToken = (t) => {
          if (!t) return '';
          if (['niche','ניש','نيش'].includes(t)) return 'niche';
          if (['selective_men','men','رجالي','לגבר','גבר'].includes(t)) return 'selective_men';
          if (['selective_woman','women','نسائي','לאישה','אישה'].includes(t)) return 'selective_woman';
          return '';
        };

        const fromTypeCell = mapTypeToken(typeRaw);
        if (fromTypeCell) {
          type = fromTypeCell;
        } else {
          const low = productName.toLowerCase();
          if (/رجالي|لرجال|\bmen\b|לגבר|גבר/.test(low)) type = 'selective_men';
          else if (/نسائي|للنساء|\bwomen\b|לאישה|אישה/.test(low)) type = 'selective_woman';
        }

        processed.push({
          id: productName.substring(0, 50) + '-' + (i + 2),
          name: (type === 'selective_men' ? DICT[currentLang].type_men_prefix :
                type === 'selective_woman' ? DICT[currentLang].type_woman_prefix : '') + productName,
          price: finalPrice,
          image: imageRaw,
          type
        });
      }

      allPerfumes = processed;
      if (allPerfumes.length === 0) {
        document.getElementById('perfume-display').innerHTML = `<h2>${DICT[currentLang].error_loading}</h2>`;
        console.warn('No products parsed. Verify sheet columns: name@C0, price@C2 or F, image@C3, optional type@C4.');
      } else {
        renderPerfumes();
      }
      document.getElementById('whatsapp-send-button').disabled = cart.length === 0;
    } catch (e) {
      console.error('Sheet parse error:', e);
      document.getElementById('perfume-display').innerHTML = `<h2>${DICT[currentLang].error_loading}</h2>`;
    }
  }).fail(function () {
    document.getElementById('perfume-display').innerHTML = `<h2>${DICT[currentLang].error_loading}</h2>`;
  });
}
