<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¹Ø·ÙˆØ± Ø§Ù„Ù†ÙŠØ´ ÙˆØ§Ù„Ø³Ù„ÙƒØªÙ Ø§Ù„Ø­ØµØ±ÙŠØ©</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --primary-color: #5d4037;
            --secondary-color: #8d6e63;
            --background-color: #f4f4f4;
            --cart-color: #fff8e1;
            --whatsapp-color: #25D366;
            --delete-color: #d32f2f;
        }

        body { 
            font-family: Tahoma, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--background-color); 
            color: #333; 
            /* Ù‡Ø§Ù…: Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø³ÙÙ„ÙŠØ© ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¹Ø±Ø¨Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© */
            padding-bottom: 120px; 
        }
        
        header { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 15px 10px; 
            text-align: center;
        }
        
        main { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 10px; 
        }
        
        section { 
            background: white; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ§Ø±ÙˆØ³ÙŠÙ„ */
        .perfume-carousel { 
            display: flex;
            overflow-x: auto; 
            padding: 10px 0;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .perfume-carousel::-webkit-scrollbar { display: none; }
        
        .perfume-item { 
            flex: 0 0 150px; /* Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø¹Ø±Ø¶ */
            border: 1px solid #ddd; padding: 8px; text-align: center; background: #fff; border-radius: 6px; 
            transition: transform 0.2s; 
        }
        .perfume-item img { width: 100%; height: auto; max-height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; }
        
        .add-to-cart { 
            background-color: var(--secondary-color); 
            color: white; 
            border: none; padding: 7px 10px; cursor: pointer; border-radius: 4px; 
            font-weight: bold; width: 100%; 
        }

        /* ************************************** */
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¨Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© (Fixed Cart) */
        /* ************************************** */
        #cart-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
            background-color: white;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            border-top: 1px solid #ddd;
            padding-bottom: env(safe-area-inset-bottom); /* Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ÙˆØªØ´ Ø§Ù„Ø¬ÙˆØ§Ù„ */
        }

        #cart-summary { 
            background: var(--cart-color); 
            padding: 10px 15px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #cart-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        #cart-list {
            list-style: none;
            padding: 0;
            margin: 5px 0;
            max-height: 50px; /* Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ø±Ø¨Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© */
            overflow-y: auto;
            font-size: 0.85em;
        }

        #cart-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
        }

        .delete-item {
            cursor: pointer;
            color: var(--delete-color);
            margin-right: 5px;
            font-size: 1em;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .delete-item:hover { opacity: 1; }

        #total-price-display {
            font-weight: bold;
            color: #b71c1c;
            font-size: 1.3em;
            white-space: nowrap; /* Ù…Ù†Ø¹ Ø§Ù†Ù‚Ø³Ø§Ù… Ø§Ù„Ø³Ø¹Ø± */
        }

        #whatsapp-send-button { 
            background-color: var(--whatsapp-color); 
            color: white; border: none; padding: 10px 15px; 
            border-radius: 5px; cursor: pointer; 
            font-size: 1em; font-weight: bold; 
            margin-right: 10px;
            white-space: nowrap;
        }
        
        #shipping-info {
            font-size: 0.75em;
            color: #555;
        }
        
        /* Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù… */
        #floating-whatsapp {
            position: fixed;
            bottom: 110px; /* ÙÙˆÙ‚ Ø§Ù„Ø¹Ø±Ø¨Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ© */
            left: 15px;
            background-color: var(--whatsapp-color);
            color: white;
            padding: 8px 12px;
            border-radius: 50px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1001;
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }
        #floating-whatsapp i {
            font-size: 1.2em;
            margin-right: 8px;
        }
        
        .offer-message {
            background-color: #e8f5e9;
            color: #1b5e20;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #c8e6c9;
        }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù„ØºØ© (Ù„Ø¶Ø¨Ø· Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©) */
        [lang="he"] #floating-whatsapp { left: auto; right: 15px; }
        [lang="he"] #floating-whatsapp i { margin-left: 0; margin-right: 8px; }
    </style>
</head>
<body lang="ar"> <header>
        <h1 id="header-title">âœ¨ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¹Ø·ÙˆØ± Ø§Ù„ÙØ§Ø®Ø±Ø© Ù„Ø§ ØªÙÙ‚Ø§ÙˆÙ…! âœ¨</h1>
        <p id="header-subtitle">â­ Ø§Ø®ØªØ± Ø¹Ø·ÙˆØ± Ø§Ù„Ù†ÙŠØ´ ÙˆØ§Ø³ØªÙØ¯ Ù…Ù† Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø£Ùˆ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§.</p>
    </header>

    <main>
        <section id="perfume-display">
            <h2 id="loading-message">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø·ÙˆØ±...</h2>
        </section>
    </main>

    <a id="floating-whatsapp" href="#" target="_blank">
        <i class="fab fa-whatsapp"></i> <span id="whatsapp-float-text">Ø£Ø±ØºØ¨ Ø¨Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ù†ÙŠØ´</span>
    </a>

    <div id="cart-container">
        <aside id="cart-summary">
            <div id="cart-details">
                <ul id="cart-list"></ul>
                <p id="shipping-info"></p>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 5px;">
                    <span id="total-text">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                    <span id="total-price-display">0.00 â‚ª</span>
                </div>
            </div>
            <button id="whatsapp-send-button" disabled>
                Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
            </button>
        </aside>
    </div>

    <script>
        // ******************************************************
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ù…Ø­Ù„ÙŠØ©
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1g3_D2NBwT27O2OI-v1R5tAB2QCfF3_ZCUL9sSLoCv54/gviz/tq?tqx=out:json';
        const PHONE_NUMBER = "972522511749"; 
        const CURRENCY_SYMBOL = " â‚ª";
        const SHIPPING_FEE = 50; // Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© (50 Ø´ÙŠÙƒÙ„)

        // Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø·Ø± Ù„Ù„ØªØµÙ†ÙŠÙ (ÙÙŠ Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø¯Ø£ Ø³Ø·Ø±Ù‡ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ù€ 1)
        const ROWS_RANGES = {
            'selective_men': { start: 2, end: 109 },
            'selective_woman': { start: 110, end: 231 },
            'niche': { start: 232, end: 289 }
        };

        // Ù†ØµÙˆØµ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¹Ø¨Ø±ÙŠØ©
        const DICT = {
            ar: {
                title: 'âœ¨ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¹Ø·ÙˆØ± Ø§Ù„ÙØ§Ø®Ø±Ø© Ù„Ø§ ØªÙÙ‚Ø§ÙˆÙ…! âœ¨',
                subtitle: 'â­ Ø§Ø®ØªØ± Ø¹Ø·ÙˆØ± Ø§Ù„Ù†ÙŠØ´ ÙˆØ§Ø³ØªÙØ¯ Ù…Ù† Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø£Ùˆ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§.',
                loading: 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø·ÙˆØ±...',
                niche_header: 'Ø¹Ø·ÙˆØ± Ø§Ù„Ù†ÙŠØ´ Ø§Ù„ÙØ§Ø®Ø±Ø©',
                niche_offer_msg: 'Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø·Ø± Ø£Ùˆ Ø¹Ø·Ø±ÙŠÙ† Ù†ÙŠØ´ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¶.',
                men_header: 'Ø¹Ø·ÙˆØ± Ø³Ù„ÙƒØªÙ Ø±Ø¬Ø§Ù„ÙŠ',
                woman_header: 'Ø¹Ø·ÙˆØ± Ø³Ù„ÙƒØªÙ Ù†Ø³Ø§Ø¦ÙŠ',
                add_to_cart: 'Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©',
                total_text: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:',
                shipping_text: 'Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: ' + SHIPPING_FEE.toFixed(2) + CURRENCY_SYMBOL,
                shipping_free: 'Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: Ù…Ø¬Ø§Ù†Ø§Ù‹!',
                complete_order: 'Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨',
                cart_empty: 'Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©.',
                item_added: 'Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø·Ø± Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©.',
                whatsapp_float: 'Ø£Ø±ØºØ¨ Ø¨Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ù†ÙŠØ´',
                msg_gift: 'Ù‡Ø¯ÙŠØ© Ù…Ø¬Ø§Ù†ÙŠØ©',
                msg_discount: 'Ø®ØµÙ… 50%',
                msg_order_complete: 'Ø·Ù„Ø¨ Ø¹Ø·ÙˆØ± Ø¬Ø¯ÙŠØ¯:',
                msg_no_offer: 'Ù„Ù… ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø±Ø¶.',
                type_niche: 'Ù†ÙŠØ´',
                type_selective: 'Ø³Ù„ÙƒØªÙ',
                type_men_prefix: 'Ø±Ø¬Ø§Ù„ÙŠ: ',
                type_woman_prefix: 'Ù†Ø³Ø§Ø¦ÙŠ: '
            },
            he: {
                title: 'âœ¨ ××‘×¦×¢×™ ×‘×™×©×•× ×™×•×§×¨×ª×™×™×! âœ¨',
                subtitle: 'â­ ×‘×—×¨ ×‘×©××™ × ×™×© ×•×§×‘×œ ×”× ×—×•×ª ××• ××ª× ×•×ª.',
                loading: '×˜×•×¢×Ÿ ×‘×©××™×...',
                niche_header: '×‘×©××™ × ×™×© ×™×•×§×¨×ª×™×™×',
                niche_offer_msg: '×‘×—×¨ ×‘×•×©× × ×™×© ××—×“ ××• ×©× ×™×™× ×›×“×™ ×œ×§×‘×œ ××ª ×”××‘×¦×¢.',
                men_header: '×‘×©××™ ×¡×œ×§×˜×™×‘ ×œ×’×‘×¨',
                woman_header: '×‘×©××™ ×¡×œ×§×˜×™×‘ ×œ××™×©×”',
                add_to_cart: '×”×•×¡×£ ×œ×¡×œ',
                total_text: '×¡×”"×›:',
                shipping_text: '×“××™ ××©×œ×•×—: ' + SHIPPING_FEE.toFixed(2) + CURRENCY_SYMBOL,
                shipping_free: '×“××™ ××©×œ×•×—: ×—×™× ×!',
                complete_order: '×¡×™×™× ×”×–×× ×”',
                cart_empty: '×”×¡×œ ×¨×™×§.',
                item_added: '×¤×¨×™×˜ ×–×” ×›×‘×¨ ×§×™×™× ×‘×¡×œ.',
                whatsapp_float: '×× ×™ ×¨×•×¦×” ××ª ××‘×¦×¢ ×”× ×™×©',
                msg_gift: '××ª× ×” ×—×™× ×',
                msg_discount: '50% ×”× ×—×”',
                msg_order_complete: '×”×–×× ×ª ×‘×©××™× ×—×“×©×”:',
                msg_no_offer: '×œ× ×”×•×—×œ ××‘×¦×¢.',
                type_niche: '× ×™×©',
                type_selective: '×¡×œ×§×˜×™×‘',
                type_men_prefix: '×’×‘×¨: ',
                type_woman_prefix: '××™×©×”: '
            }
        };

        let currentLang = 'ar';
        let allPerfumes = [];
        let cart = [];

        // ********** Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ© **********
        function setLanguage() {
            const browserLang = navigator.language.substring(0, 2).toLowerCase();
            if (browserLang === 'he') {
                currentLang = 'he';
                document.documentElement.setAttribute('lang', 'he');
                document.documentElement.setAttribute('dir', 'rtl');
                
                // ØªØ­Ø¯ÙŠØ« Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„ÙŠÙ…ÙŠÙ†
                document.getElementById('floating-whatsapp').style.right = '15px';
                document.getElementById('floating-whatsapp').style.left = 'auto';
            } else {
                currentLang = 'ar';
            }
            // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
            updateTexts();
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ©
        function updateTexts() {
            const t = DICT[currentLang];
            document.getElementById('page-title').textContent = t.title;
            document.getElementById('header-title').textContent = t.title;
            document.getElementById('header-subtitle').textContent = t.subtitle;
            document.getElementById('loading-message').textContent = t.loading;
            document.getElementById('total-text').textContent = t.total_text;
            document.getElementById('whatsapp-send-button').textContent = t.complete_order;
            document.getElementById('whatsapp-float-text').textContent = t.whatsapp_float;
            
            // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù…
            document.getElementById('floating-whatsapp').href = `https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(t.whatsapp_float)}`;
        }


        // ********** Ù…Ù†Ø·Ù‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø© **********

        function createPerfumeItem(perfume) {
            // ... (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚) ...
            const div = document.createElement('div');
            div.className = 'perfume-item';
            div.dataset.id = perfume.id;
            div.dataset.type = perfume.type;
            div.dataset.price = perfume.price;
            div.dataset.name = perfume.name;

            let imgUrl = perfume.image && perfume.image.trim() ? perfume.image : 'https://via.placeholder.com/180?text=No+Image';

            if (imgUrl.startsWith('http://') && !imgUrl.startsWith('https://')) {
                imgUrl = imgUrl.replace('http://', 'https://');
            }

            const t = DICT[currentLang];
            div.innerHTML = `
                <img src="${imgUrl}" alt="${perfume.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/180?text=No+Image';">
                <h3>${perfume.name}</h3>
                <p>${perfume.price.toFixed(2)}${CURRENCY_SYMBOL}</p>
                <button class="add-to-cart">${t.add_to_cart}</button>
            `;
            return div;
        }

        function renderPerfumes() {
            const displaySection = document.getElementById('perfume-display');
            displaySection.innerHTML = ''; 

            const nichePerfumes = allPerfumes.filter(p => p.type === 'niche');
            const selectiveMenPerfumes = allPerfumes.filter(p => p.type === 'selective_men');
            const selectiveWomanPerfumes = allPerfumes.filter(p => p.type === 'selective_woman');
            
            const t = DICT[currentLang];
            
            // 1. Ø¹Ø±Ø¶ Ø¹Ø·ÙˆØ± Ø§Ù„Ù†ÙŠØ´
            displaySection.innerHTML += `
                <div class="offer-message">${t.niche_offer_msg}</div>
                <h2>${t.niche_header}</h2>
                <div class="perfume-carousel" id="niche-carousel"></div>
            `;
            const nicheCarousel = document.getElementById('niche-carousel');
            nichePerfumes.forEach(p => nicheCarousel.appendChild(createPerfumeItem(p)));

            // 2. Ø¹Ø±Ø¶ Ø¹Ø·ÙˆØ± Ø³Ù„ÙƒØªÙ Ø±Ø¬Ø§Ù„ÙŠ
            displaySection.innerHTML += `<hr style="margin: 30px 0;"><h2>${t.men_header}</h2><div class="perfume-carousel" id="selective-men-carousel"></div>`;
            const selectiveMenCarousel = document.getElementById('selective-men-carousel');
            selectiveMenPerfumes.forEach(p => selectiveMenCarousel.appendChild(createPerfumeItem(p)));
            
            // 3. Ø¹Ø±Ø¶ Ø¹Ø·ÙˆØ± Ø³Ù„ÙƒØªÙ Ù†Ø³Ø§Ø¦ÙŠ
            displaySection.innerHTML += `<hr style="margin: 30px 0;"><h2>${t.woman_header}</h2><div class="perfume-carousel" id="selective-woman-carousel"></div>`;
            const selectiveWomanCarousel = document.getElementById('selective-woman-carousel');
            selectiveWomanPerfumes.forEach(p => selectiveWomanCarousel.appendChild(createPerfumeItem(p)));

            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', addToCart);
            });
        }
        
        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
        function removeItemFromCart(index) {
            cart.splice(index, 1);
            updateCartAndOffers();
        }

        function updateCartAndOffers() {
            // 1. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³Ù„ÙƒØªÙ
            cart.forEach(item => {
                if (item.type.startsWith('selective')) {
                    item.finalPrice = item.basePrice; 
                    item.isDiscounted = false;
                    item.isFreeGift = false;
                }
            });

            // 2. Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø¹Ø·ÙˆØ± Ø§Ù„Ù†ÙŠØ´
            const nicheCount = cart.filter(item => item.type === 'niche').length;

            // 3. ØªØ­Ø¯ÙŠØ¯ Ø£Ø±Ø®Øµ Ø¹Ø·Ø± Ø³Ù„ÙƒØªÙ ÙÙŠ Ø§Ù„Ø³Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„ÙŠÙ‡
            let selectiveItems = cart
                .filter(item => item.type.startsWith('selective'))
                .sort((a, b) => a.basePrice - b.basePrice); 
            
            if (selectiveItems.length > 0) {
                const cheapestSelective = selectiveItems[0]; 

                if (nicheCount === 1) {
                    cheapestSelective.finalPrice = cheapestSelective.basePrice / 2;
                    cheapestSelective.isDiscounted = true;

                } else if (nicheCount >= 2) {
                    cheapestSelective.finalPrice = 0;
                    cheapestSelective.isDiscounted = true;
                    cheapestSelective.isFreeGift = true;
                }
            }
            renderCartSummary();
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù„Ø©
        function renderCartSummary() {
            const cartList = document.getElementById('cart-list');
            const totalPriceDisplay = document.getElementById('total-price-display');
            const shippingInfo = document.getElementById('shipping-info');
            const t = DICT[currentLang];
            let subtotal = 0;
            
            cartList.innerHTML = ''; 

            cart.forEach((item, index) => {
                subtotal += item.finalPrice;
                const li = document.createElement('li');
                
                let priceText = `${item.finalPrice.toFixed(2)}${CURRENCY_SYMBOL}`;
                let typeName = item.type.includes('niche') ? t.type_niche : t.type_selective;

                if (item.isDiscounted) {
                    if (item.isFreeGift) {
                        priceText = `<span class="gift">${t.msg_gift}</span>`;
                    } else {
                        priceText = `<span class="discount">${priceText}</span> (${t.msg_discount})`;
                    }
                }

                li.innerHTML = `
                    <div>
                        <i class="fas fa-trash-alt delete-item" onclick="removeItemFromCart(${index})"></i>
                        ${item.name}
                    </div>
                    <span>${priceText}</span>
                `;
                cartList.appendChild(li);
            });

            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„
            let finalTotal = subtotal;
            if (subtotal > 0) {
                finalTotal += SHIPPING_FEE;
                shippingInfo.innerHTML = t.shipping_text;
            } else {
                shippingInfo.innerHTML = '';
            }

            totalPriceDisplay.textContent = finalTotal.toFixed(2) + CURRENCY_SYMBOL;
            
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø³Ù„Ø©
            document.getElementById('whatsapp-send-button').disabled = (cart.length === 0);
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù„Ù… ØªØªØºÙŠØ±)
        function fetchAndProcessProducts() {
            $.get(SHEET_URL, function (response) {
                try {
                    const jsonText = response.match(/google\.visualization\.Query\.setResponse\((.*)\)/)[1];
                    const jsonData = JSON.parse(jsonText);
                    const rows = jsonData.table.rows;

                    const processedProducts = [];

                    for (let i = 0; i < rows.length; i++) {
                        
                        const sheetRowNumber = i + 2; 
                        if (sheetRowNumber > 289) break; 
                        
                        const row = rows[i].c;

                        const productName = row[0]?.v || '';     // C0
                        const productCategoryRaw = row[1]?.v || ''; // C1 (Ø§Ù„ÙˆØµÙ)
                        const productPriceC2 = parseFloat(row[2]?.v) || 0; // C2
                        const productImageLink = row[3]?.v || ''; // C3
                        const priceFromF = parseFloat(row[5]?.v) || 0; // C5 (Ø§Ù„Ø¹Ù…ÙˆØ¯ F)
                        
                        const finalPrice = priceFromF > 0 ? priceFromF : productPriceC2;

                        if (!productName || finalPrice === 0) continue; 
                        
                        let type = '';
                        let namePrefix = '';
                        
                        // *** Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± ***
                        if (sheetRowNumber >= ROWS_RANGES.niche.start && sheetRowNumber <= ROWS_RANGES.niche.end) {
                            type = 'niche';
                        } else if (sheetRowNumber >= ROWS_RANGES.selective_men.start && sheetRowNumber <= ROWS_RANGES.selective_men.end) {
                            type = 'selective_men';
                            namePrefix = DICT[currentLang].type_men_prefix;
                        } else if (sheetRowNumber >= ROWS_RANGES.selective_woman.start && sheetRowNumber <= ROWS_RANGES.selective_woman.end) {
                            type = 'selective_woman';
                            namePrefix = DICT[currentLang].type_woman_prefix;
                        } else {
                            continue;
                        }

                        processedProducts.push({
                            id: productName.substring(0, 50) + '-' + sheetRowNumber,
                            name: namePrefix + productName,
                            price: finalPrice,
                            image: productImageLink,
                            type: type
                        });
                    }

                    allPerfumes = processedProducts;
                    renderPerfumes();
                    document.getElementById('whatsapp-send-button').disabled = false;

                } catch (e) {
                    console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´ÙŠØª:", e);
                    document.getElementById('perfume-display').innerHTML = `<h2>${DICT[currentLang].loading}</h2>`;
                }
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
        function sendOrderViaWhatsApp() {
            if (cart.length === 0) {
                alert(DICT[currentLang].cart_empty);
                return;
            }

            const t = DICT[currentLang];
            const nicheCount = cart.filter(item => item.type === 'niche').length;
            let message = `ğŸ‰ *${t.msg_order_complete}*\n\n*1. ${t.niche_header} Ùˆ ${t.type_selective}:*\n`;
            let subtotal = 0;
            let finalTotal = 0;

            cart.forEach(item => {
                subtotal += item.finalPrice;
                let priceText = `${item.finalPrice.toFixed(2)}${CURRENCY_SYMBOL}`;

                if (item.isDiscounted) {
                    priceText = (item.isFreeGift) 
                                ? `ğŸ *${t.msg_gift}*`
                                : `ğŸ’° *${item.finalPrice.toFixed(2)}${CURRENCY_SYMBOL}* (${t.msg_discount})`;
                } else {
                    priceText = item.basePrice.toFixed(2) + CURRENCY_SYMBOL;
                }

                message += `\n- ${item.name}: ${priceText}`;
            });
            
            finalTotal = subtotal + SHIPPING_FEE;

            let offerSummary = "\n\n*2. Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø±Ø¶:*";
            if (nicheCount === 1) {
                offerSummary += `\n- ${t.niche_header} + ${t.type_selective} Ø¨Ù†ØµÙ Ø§Ù„Ø³Ø¹Ø±.`;
            } else if (nicheCount >= 2) {
                offerSummary += `\n- ${t.niche_header} + 1 ${t.type_selective} Ù‡Ø¯ÙŠØ© Ù…Ø¬Ø§Ù†ÙŠØ©.`;
            } else {
                offerSummary += `\n- ${t.msg_no_offer}`;
            }
            
            message += offerSummary;
            
            message += `\n\n====================\n`;
            message += `ğŸšš ${t.shipping_text}: ${SHIPPING_FEE.toFixed(2)}${CURRENCY_SYMBOL}`;
            message += `\nğŸ’µ *${t.total_text}* ${finalTotal.toFixed(2)}${CURRENCY_SYMBOL}`;
            
            const pageUrl = window.location.href; 
            message += `\n\n${t.complete_order} Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø·: ${pageUrl}`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${PHONE_NUMBER}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // ØªØ´ØºÙŠÙ„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(); // Ø¶Ø¨Ø· Ø§Ù„Ù„ØºØ© Ø£ÙˆÙ„Ø§Ù‹
            fetchAndProcessProducts();
            document.getElementById('whatsapp-send-button').addEventListener('click', sendOrderViaWhatsApp);
        });
    </script>
</body>
</html>
